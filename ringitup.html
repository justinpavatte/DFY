<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ring It Up</title>
    <!-- https://favicon.io/favicon-converter/ -->
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <div class="container">

        <div class="headerRow" style="position:relative; height:46px; margin-bottom:4px;">
            <label for="subTotal" style="position:absolute; left:0; top:15px;">Enter Individual Items:</label>
            <button id="refreshBtn" type="button" aria-label="Refresh" style="
                position:absolute; right:-5px; top:5px; width:34px; height:34px;
                border:1px solid #555; border-radius:6px; background:#222; color:#ddd;
                display:flex; align-items:center; justify-content:center; font-size:20px;
                line-height:1; cursor:pointer; -webkit-tap-highlight-color:transparent;">
                ↻
            </button>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                document.getElementById("refreshBtn").onclick = () => location.reload();
            });
        </script>

        <div id="subTotalsContainer">
            <input id="subTotal" class="subTotalInput" type="text" inputmode="decimal" autofocus />
        </div>
        <div><button id="ringItUp" onclick="calcTax()">Ring It Up</button></div>

        <div id="resultArea" style="display:none;">
            <div><label for="subtotalAll">Subtotal:</label></div>
            <div><input readonly id="subtotalAll"></div>

            <div><label for="tax">Tax:</label></div>
            <div><input readonly id="tax"></div>

            <div><label for="outTheDoorPrice">Out The Door Price:</label></div>
            <div><input readonly id="outTheDoorPrice"></div>

            <div><br><label><i>Shortcut...</i></label></div>
            <div><label id="lblShor"></label></div>
            <div><input readonly id="frml"></div>

            <div><br><label><i>Details...</i></label></div>

            <div><label for="frmlExpanded">expanded formula:</label></div>
            <div><textarea readonly id="frmlExpanded" style="height:250px;"></textarea></div>

            <div><label for="frmlExpandedValues">expanded values:</label></div>
            <div><textarea readonly id="frmlExpandedValues" style="height:150px;"></textarea></div>
        </div>
    </div>

    <div id="popup" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:99999;">
        <div style="position:absolute; inset:0; background:rgba(0,0,0,0.5)"></div>
        <div style="position:relative; max-width:420px; width:90%; background:#222; border:1px solid #555;
                    border-radius:10px; padding:16px; box-shadow:0 8px 32px rgba(0,0,0,0.6);">
            <div id="popupTitle" style="font-weight:600; margin-bottom:8px;">Notice</div>
            <div id="popupMsg" style="margin-bottom:12px; white-space:pre-wrap;"></div>
            <div style="display:flex; justify-content:flex-end;">
                <button id="popupOk" style="padding:8px 14px; border:1px solid #555; border-radius:8px; background:#2a2a2a; color:#ddd;">OK</button>
            </div>
        </div>
    </div>

    <script src="constants.js"></script>
    <script src="helpers.js"></script>
    <script src="todoist.js"></script>

    <script>
        function showPopup(msg) {
            const p = document.getElementById('popup');
            document.getElementById('popupMsg').textContent = msg;
            p.style.display = 'flex';
            document.getElementById('popupOk').focus();
        }
        function hidePopup() { document.getElementById('popup').style.display = 'none'; }
        document.getElementById('popupOk').onclick = hidePopup;
        document.getElementById('popup').onclick = e => { if (e.target.id === 'popup') hidePopup(); };
        document.onkeydown = e => { if (e.key === 'Escape') hidePopup(); };

        function toNum(v) {
            const t = String(v ?? '').trim();
            if (t === '') return NaN;
            const n = parseFloat(t);
            return Number.isFinite(n) ? n : NaN;
        }
        function isLastInput(el) {
            const inputs = document.querySelectorAll('.subTotalInput');
            return inputs.length && inputs[inputs.length - 1] === el;
        }

        function makeLineForInput(inputEl) {
            const c = document.getElementById('subTotalsContainer');

            const row = document.createElement('div');
            row.className = 'lineRow';
            row.style.display = 'grid';
            row.style.gridTemplateColumns = '1fr auto';
            row.style.columnGap = '0';
            row.style.alignItems = 'center';
            row.style.marginBottom = '4px';

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'discToggleBtn';
            btn.textContent = '↓';
            Object.assign(btn.style, {
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                width: '34px', height: '30px', padding: '0',
                border: '1px solid #555', borderRadius: '6px',
                background: '#222', color: '#ddd', cursor: 'pointer',
                margin: '0 0 0 -1px', lineHeight: '1', fontSize: '18px'
            });

            const discountWrap = document.createElement('div');
            discountWrap.className = 'discountWrap';
            discountWrap.style.display = 'none';
            discountWrap.style.margin = '0 0 2px 24px';

            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'auto 1fr';
            grid.style.columnGap = '12px';

            const lblD = document.createElement('label');
            lblD.textContent = 'Discount';
            lblD.style.margin = '0 0 2px 6px';

            const lblAfter = document.createElement('label');
            lblAfter.textContent = 'Result';
            lblAfter.style.margin = '0 0 2px 6px';

            const discWrap = document.createElement('div');
            discWrap.style.display = 'inline-flex';
            discWrap.style.alignItems = 'center';
            discWrap.style.gap = '1px';

            const disc = document.createElement('input');
            disc.type = 'text';
            disc.inputMode = 'decimal';
            disc.className = 'discountInput';
            disc.style.width = '70px';

            const percentSuffix = document.createElement('span');
            percentSuffix.textContent = '%';
            percentSuffix.style.fontSize = '20px';
            percentSuffix.style.lineHeight = '1';
            percentSuffix.style.marginLeft = '0';

            discWrap.appendChild(disc);
            discWrap.appendChild(percentSuffix);

            const after = document.createElement('input');
            after.type = 'text';
            after.readOnly = true;
            after.className = 'discountResult';

            grid.appendChild(lblD);
            grid.appendChild(lblAfter);
            grid.appendChild(discWrap);
            grid.appendChild(after);
            discountWrap.appendChild(grid);

            const old = inputEl;
            const placeholder = document.createElement('span');
            c.replaceChild(placeholder, old);
            row.appendChild(old);
            row.appendChild(btn);
            c.replaceChild(row, placeholder);
            c.insertBefore(discountWrap, row.nextSibling);

            function normDiscount(raw) {
                if (!Number.isFinite(raw) || raw < 0) return 0;
                return raw > 1 ? raw / 100 : raw;
            }
            function adjusted() {
                const p = toNum(old.value);
                const dRaw = toNum(disc.value);
                const d = normDiscount(dRaw);
                if (Number.isFinite(p)) {
                    const val = preciseRound(p * (1 - d), 2);
                    const fixed = val.toFixed(2);
                    after.value = fixed;
                    after.dataset.rounded = fixed;
                } else {
                    after.value = '';
                    after.dataset.rounded = '';
                }
            }

            disc.oninput = adjusted;
            old.oninput = adjusted;

            btn.onclick = () => {
                const willShow = discountWrap.style.display === 'none' || discountWrap.style.display === '';
                discountWrap.style.display = willShow ? 'block' : 'none';
                adjusted();
                if (willShow) {
                    setTimeout(() => { disc.focus(); disc.select(); }, 0);
                }
            };
        }

        function addEmptyInput() {
            const c = document.getElementById('subTotalsContainer');
            const i = document.createElement('input');
            i.type = 'text';
            i.inputMode = 'decimal';
            i.className = 'subTotalInput';
            c.appendChild(i);
            makeLineForInput(i);
            attachBehavior(i);
        }

        function attachBehavior(inputEl) {
            inputEl.oninput = () => { if (isLastInput(inputEl) && inputEl.value.trim() !== '') addEmptyInput(); };
            inputEl.onkeydown = (event) => { if (event.key === 'Enter') { event.preventDefault(); calcTax(); } };
        }

        (function initMulti() {
            const first = document.getElementById('subTotal');
            makeLineForInput(first);
            attachBehavior(first);
        })();

        function clearResults() {
            document.getElementById('subtotalAll').value = "";
            document.getElementById('tax').value = "";
            document.getElementById('outTheDoorPrice').value = "";
            document.getElementById('frml').value = "";
            document.getElementById('frmlExpanded').value = "";
            document.getElementById('frmlExpandedValues').value = "";
            document.getElementById('lblShor').innerText = "";
            document.getElementById('resultArea').style.display = 'none';
        }
function calcTax() {
    const inputs = document.querySelectorAll('.subTotalInput');
    const nums = [];

    for (const el of inputs) {
        const base = toNum(el.value);
        if (!Number.isFinite(base)) continue;

        let line = base;

        const wrap = el.parentElement.nextElementSibling;
        if (wrap && wrap.classList.contains('discountWrap')) {
            const discEl = wrap.querySelector('.discountInput');
            const dv = toNum(discEl.value);
            if (Number.isFinite(dv)) {
                const frac = dv > 1 ? dv / 100 : Math.max(0, dv);
                line = preciseRound(base * (1 - frac), 2);
            } else {
                line = preciseRound(base, 2);
            }
        } else {
            line = preciseRound(base, 2);
        }

        nums.push(line);
    }

    if (nums.length > 1 && nums.some(v => v > BRACKET_INTERVAL)) {
        clearResults();
        showPopup('Single items over $1600 must be done on a separate sales ticket.');
        return;
    }

    const toCents = (v) => BigInt(Math.round(v * 100));
    const fromCents = (c) => Number(c) / 100;
    const toBps = (rate) => BigInt(Math.round(rate * 10000));
    const roundDiv = (num, den) => (num + (den / 2n)) / den;

    const subtotalCents = nums.reduce((acc, v) => acc + toCents(v), 0n);

    if (subtotalCents === 0n) {
        clearResults();
        return;
    }

    let taxUnits = 0n;

    if (nums.length > 1) {
        const rateBps = toBps(BASE_STATE_TAX + LOCAL_TAX);
        taxUnits = subtotalCents * rateBps;
        document.getElementById('lblShor').innerText = "multiple items <= 1600 each";
        document.getElementById('frml').value = "x*1.0925";
        document.getElementById('frmlExpanded').value = "subtotal * (BASE_STATE_TAX + LOCAL_TAX)";
        document.getElementById('frmlExpandedValues').value = `${fromCents(subtotalCents).toFixed(2)} * (${BASE_STATE_TAX} + ${LOCAL_TAX})`;
    } else {
        const singleCents = toCents(nums[0]);
        const bracketCents = toCents(BRACKET_INTERVAL);

        if (singleCents <= bracketCents) {
            const rateBps = toBps(BASE_STATE_TAX + LOCAL_TAX);
            taxUnits = singleCents * rateBps;
            document.getElementById('lblShor').innerText = "subtotal <= 1600";
            document.getElementById('frml').value = "x*1.0925";
            document.getElementById('frmlExpanded').value = "numberInput + numberInput * (BASE_STATE_TAX + LOCAL_TAX)";
            document.getElementById('frmlExpandedValues').value = `${fromCents(singleCents).toFixed(2)} + ${fromCents(singleCents).toFixed(2)} * (${BASE_STATE_TAX} + ${LOCAL_TAX})`;
        } else if (singleCents <= bracketCents * 2n) {
            const r1 = toBps(BASE_STATE_TAX + LOCAL_TAX);
            const r2 = toBps(BASE_STATE_TAX + EXTRA_STATE_TAX);
            const over = singleCents - bracketCents;
            taxUnits = bracketCents * r1 + over * r2;

            document.getElementById('lblShor').innerText = "1600 < subtotal <= 3200";
            document.getElementById('frml').value = "1.0975x−8";
            document.getElementById('frmlExpanded').value =
                "numberInput + BRACKET_INTERVAL * (BASE_STATE_TAX + LOCAL_TAX) + (numberInput - BRACKET_INTERVAL) * (BASE_STATE_TAX + EXTRA_STATE_TAX)";
            document.getElementById('frmlExpandedValues').value =
                `${fromCents(singleCents).toFixed(2)} + ${fromCents(bracketCents).toFixed(2)} * (${BASE_STATE_TAX} + ${LOCAL_TAX}) + (${fromCents(singleCents).toFixed(2)} - ${fromCents(bracketCents).toFixed(2)}) * (${BASE_STATE_TAX} + ${EXTRA_STATE_TAX})`;
        } else {
            const r1 = toBps(BASE_STATE_TAX + LOCAL_TAX);
            const r2 = toBps(BASE_STATE_TAX + EXTRA_STATE_TAX);
            const r3 = toBps(BASE_STATE_TAX);
            const over = singleCents - bracketCents * 2n;
            taxUnits = bracketCents * r1 + bracketCents * r2 + over * r3;

            document.getElementById('lblShor').innerText = "subtotal > 3200";
            document.getElementById('frml').value = "1.07x+80";
            document.getElementById('frmlExpanded').value =
                "numberInput + BRACKET_INTERVAL * (BASE_STATE_TAX + LOCAL_TAX) + BRACKET_INTERVAL * (BASE_STATE_TAX + EXTRA_STATE_TAX) + (numberInput - BRACKET_INTERVAL * 2) * BASE_STATE_TAX";
            document.getElementById('frmlExpandedValues').value =
                `${fromCents(singleCents).toFixed(2)} + ${fromCents(bracketCents).toFixed(2)} * (${BASE_STATE_TAX} + ${LOCAL_TAX}) + ${fromCents(bracketCents).toFixed(2)} * (${BASE_STATE_TAX} + ${EXTRA_STATE_TAX}) + (${fromCents(singleCents).toFixed(2)} - ${fromCents(bracketCents * 2n).toFixed(2)}) * ${BASE_STATE_TAX}`;
        }
    }

    const taxCents = roundDiv(taxUnits, 10000n);
    const totalCents = subtotalCents + taxCents;

    document.getElementById('subtotalAll').value = fromCents(subtotalCents).toFixed(2);
    document.getElementById('tax').value = fromCents(taxCents).toFixed(2);
    document.getElementById('outTheDoorPrice').value = fromCents(totalCents).toFixed(2);
    document.getElementById('resultArea').style.display = 'block';

    writeToLog(`
RING IT UP
Subtotal: ${fromCents(subtotalCents).toFixed(2)}
Tax: ${fromCents(taxCents).toFixed(2)}
Out The Door Price: ${fromCents(totalCents).toFixed(2)}
`);
}

        //make enter the accept button
        document.getElementById('subTotal').onkeydown = function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                calcTax();
            }
        };
    </script>
</body>
</html>
