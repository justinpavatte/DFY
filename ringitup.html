<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ring It Up</title>
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <div class="container">

        <!-- Header -->
        <div class="headerRow" style="position:relative; height:46px; margin-bottom:4px;">
            <label for="subTotal"
                   style="position:absolute; left:0; top:15px;">
                Items:
            </label>

            <button id="refreshBtn"
                type="button"
                aria-label="Refresh"
                style="
                    position:absolute;
                    right:-5px;
                    top:5px;
                    width:34px;
                    height:34px;
                    border:1px solid #555;
                    border-radius:6px;
                    background:#222;
                    color:#ddd;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    font-size:20px;
                    line-height:1;
                    cursor:pointer;
                    -webkit-tap-highlight-color:transparent;
                ">
                ↻
            </button>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                document.getElementById("refreshBtn").onclick = () => location.reload();
            });
        </script>

        <div id="subTotalsContainer">
            <input id="subTotal" class="subTotalInput" type="text" inputmode="decimal" autofocus />
        </div>
        <div><button id="ringItUp" onclick="calcTax()">Ring It Up</button></div>

        <div id="resultArea" style="display:none;">
            <div><label for="subtotalAll">Subtotal:</label></div>
            <div><input readonly id="subtotalAll"></div>

            <div><label for="tax">Tax:</label></div>
            <div><input readonly id="tax"></div>

            <div><label for="outTheDoorPrice">Out The Door Price:</label></div>
            <div><input readonly id="outTheDoorPrice"></div>

            <div><br><label><i>Shortcut...</i></label></div>
            <div><label id="lblShor"></label></div>
            <div><input readonly id="frml"></div>

            <div><br><label><i>Details...</i></label></div>

            <div><label for="frmlExpanded">expanded formula:</label></div>
            <div><textarea readonly id="frmlExpanded" style="height:250px;"></textarea></div>

            <div><label for="frmlExpandedValues">expanded values:</label></div>
            <div><textarea readonly id="frmlExpandedValues" style="height:150px;"></textarea></div>
        </div>
    </div>


    <!-- Popup -->
    <div id="popup"
         style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:99999;">
        <div style="position:absolute; inset:0; background:rgba(0,0,0,0.5)"></div>
        <div style="position:relative; max-width:420px; width:90%; background:#222; border:1px solid #555;
                    border-radius:10px; padding:16px; box-shadow:0 8px 32px rgba(0,0,0,0.6);">
            <div id="popupTitle" style="font-weight:600; margin-bottom:8px;">Notice</div>
            <div id="popupMsg" style="margin-bottom:12px; white-space:pre-wrap;"></div>
            <div style="display:flex; justify-content:flex-end;">
                <button id="popupOk"
                    style="padding:8px 14px; border:1px solid #555; border-radius:8px; background:#2a2a2a; color:#ddd;">
                    OK
                </button>
            </div>
        </div>
    </div>


    <script src="constants.js"></script>
    <script src="helpers.js"></script>
    <script src="todoist.js"></script>

    <script>

        /* Popup Logic */
        function showPopup(msg){
            const p=document.getElementById('popup');
            document.getElementById('popupMsg').textContent=msg;
            p.style.display='flex';
            document.getElementById('popupOk').focus();
        }
        function hidePopup(){document.getElementById('popup').style.display='none'}
        document.getElementById('popupOk').onclick = hidePopup;
        document.getElementById('popup').onclick = e => { if(e.target.id==='popup') hidePopup(); };
        document.onkeydown = e => { if(e.key==='Escape') hidePopup(); };


        /* Helpers */
        function toNum(v){const t=String(v??'').trim();if(t==='')return NaN;const n=parseFloat(t);return Number.isFinite(n)?n:NaN;}
        function isLastInput(el){const inputs=document.querySelectorAll('.subTotalInput');return inputs.length&&inputs[inputs.length-1]===el;}

        function makeLineForInput(inputEl){
            const c=document.getElementById('subTotalsContainer');

            const row=document.createElement('div');
            row.className='lineRow';
            row.style.display='grid';
            row.style.gridTemplateColumns='1fr auto';
            row.style.columnGap='0';
            row.style.alignItems='center';
            row.style.marginBottom='4px';

            const btn=document.createElement('button');
            btn.textContent='↓';
            btn.className='discToggleBtn';
            btn.type='button';
            Object.assign(btn.style,{
                display:'flex',alignItems:'center',justifyContent:'center',
                width:'34px',height:'30px',padding:'0',
                border:'1px solid #555',borderRadius:'6px',
                background:'#222',color:'#ddd',cursor:'pointer',
                margin:'0 0 0 -1px',lineHeight:'1',fontSize:'18px'
            });

            const discountWrap=document.createElement('div');
            discountWrap.className='discountWrap';
            discountWrap.style.display='none';
            discountWrap.style.margin='0 0 2px 24px';

            const grid=document.createElement('div');
            grid.style.display='grid';
            grid.style.gridTemplateColumns='auto 1fr';
            grid.style.columnGap='12px';

            /* ✅ NEW LABEL MARGINS (top -12px, bottom -5px) */
            const lblD=document.createElement('label');
            lblD.textContent='Discount';
            lblD.style.margin='1px 0 -3px 6px';

            const lblAfter=document.createElement('label');
            lblAfter.textContent='Result';
            lblAfter.style.margin='1px 0 -3px 6px';

            const discWrap=document.createElement('div');
            discWrap.style.display='inline-flex';
            discWrap.style.alignItems='center';
            discWrap.style.gap='1px';

            const disc=document.createElement('input');
            disc.type='text';
            disc.inputMode='decimal';
            disc.className='discountInput';
            disc.style.width='70px';

            const percentSuffix=document.createElement('span');
            percentSuffix.textContent='%';
            percentSuffix.style.fontSize='20px';
            percentSuffix.style.marginLeft='-2px';

            discWrap.appendChild(disc);
            discWrap.appendChild(percentSuffix);

            const after=document.createElement('input');
            after.type='text';
            after.readOnly=true;

            grid.appendChild(lblD);
            grid.appendChild(lblAfter);
            grid.appendChild(discWrap);
            grid.appendChild(after);
            discountWrap.appendChild(grid);

            const old=inputEl;
            const placeholder=document.createElement('span');
            c.replaceChild(placeholder,old);
            row.appendChild(old);
            row.appendChild(btn);
            c.replaceChild(row,placeholder);
            c.insertBefore(discountWrap,row.nextSibling);

            function normDiscount(raw){if(!Number.isFinite(raw)||raw<0)return 0;return raw>1?raw/100:raw;}

            function adjusted(){
                const p=toNum(old.value);
                const dRaw=toNum(disc.value);
                const d=normDiscount(dRaw);
                after.value = Number.isFinite(p) ? preciseRound(p*(1-d),2).toFixed(2) : '';
            }

            disc.oninput = adjusted;
            old.oninput = adjusted;

            btn.onclick = ()=>{
                discountWrap.style.display =
                    discountWrap.style.display==='none' ? 'block' : 'none';
                adjusted();
            };
        }

        function addEmptyInput(){
            const c=document.getElementById('subTotalsContainer');
            const i=document.createElement('input');
            i.type='text';
            i.inputMode='decimal';
            i.className='subTotalInput';
            c.appendChild(i);
            makeLineForInput(i);
            attachBehavior(i);
        }

        function attachBehavior(inputEl){
            inputEl.oninput=()=>{
                if(isLastInput(inputEl)&&inputEl.value.trim()!=='')addEmptyInput();
            };
            inputEl.onkeydown=(e)=>{
                if(e.key==='Enter'){e.preventDefault();calcTax();}
            };
        }

        (function initMulti(){
            const first=document.getElementById('subTotal');
            makeLineForInput(first);
            attachBehavior(first);
        })();

        function calcTax(){
            const inputs=document.querySelectorAll('.subTotalInput');
            const nums=[];
            for(const el of inputs){
                const wrap=el.parentElement.nextElementSibling;
                let d=0;
                if(wrap&&wrap.classList.contains('discountWrap')){
                    const dv=toNum(wrap.querySelector('.discountInput').value);
                    if(Number.isFinite(dv))d=dv>1?dv/100:Math.max(0,dv);
                }
                const p=toNum(el.value);
                if(!Number.isNaN(p))nums.push(preciseRound(p*(1-d),2));
            }

            if(nums.length>1&&nums.some(v=>v>BRACKET_INTERVAL)){
                showPopup("Single items over $1600 must be done on a separate sales ticket.");
                return;
            }

            const subtotal = nums.reduce((a,b)=>a+b,0);
            if(!Number.isFinite(subtotal)||subtotal===0){
                document.getElementById('resultArea').style.display='none';
                document.getElementById('subtotalAll').value="";
                document.getElementById('tax').value="";
                document.getElementById('outTheDoorPrice').value="";
                return;
            }

            let tax=0;

            if(nums.length>1){
                tax = subtotal*(BASE_STATE_TAX+LOCAL_TAX);
                document.getElementById('lblShor').innerText = "multiple items <= 1600 each";
            } else {
                const single=nums[0];
                if(single<=BRACKET_INTERVAL){
                    tax=single*(BASE_STATE_TAX+LOCAL_TAX);
                    document.getElementById('lblShor').innerText="subtotal <= 1600";
                } else if(single<=BRACKET_INTERVAL*2){
                    tax = BRACKET_INTERVAL*(BASE_STATE_TAX+LOCAL_TAX)
                        + (single-BRACKET_INTERVAL)*(BASE_STATE_TAX+EXTRA_STATE_TAX);
                    document.getElementById('lblShor').innerText="1600 < subtotal <= 3200";
                } else {
                    tax = BRACKET_INTERVAL*(BASE_STATE_TAX+LOCAL_TAX)
                        + BRACKET_INTERVAL*(BASE_STATE_TAX+EXTRA_STATE_TAX)
                        + (single - BRACKET_INTERVAL*2)*BASE_STATE_TAX;
                    document.getElementById('lblShor').innerText="subtotal > 3200";
                }
            }

            const total = preciseRound(subtotal+preciseRound(tax,2),2);

            document.getElementById('subtotalAll').value=subtotal.toFixed(2);
            document.getElementById('tax').value=preciseRound(tax,2).toFixed(2);
            document.getElementById('outTheDoorPrice').value=total.toFixed(2);
            document.getElementById('resultArea').style.display='block';

            writeToLog(`
RING IT UP
Subtotal: ${subtotal}
Tax: ${tax}
Out The Door Price: ${total}
`);
        }

    </script>
</body>
</html>
